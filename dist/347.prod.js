class t{constructor(t,e,r){this.cumsum=[];for(let t=0;t<r;t++){this.cumsum.push([]);for(let r=0;r<e;r++)this.cumsum[t].push(0)}this.cumsum[0][0]=t[0];for(let r=1;r<e;r++)this.cumsum[0][r]=this.cumsum[0][r-1]+t[r];for(let a=1;a<r;a++)this.cumsum[a][0]=this.cumsum[a-1][0]+t[a*e];for(let a=1;a<r;a++)for(let r=1;r<e;r++)this.cumsum[a][r]=t[a*e+r]+this.cumsum[a-1][r]+this.cumsum[a][r-1]-this.cumsum[a-1][r-1]}query(t,e,r,a){let s=this.cumsum[a][r];return e>0&&(s-=this.cumsum[e-1][r]),t>0&&(s-=this.cumsum[a][t-1]),t>0&&e>0&&(s+=this.cumsum[e-1][t-1]),s}}const e=e=>{const{data:i,width:l,height:u,scale:h}=e,o=[l*u];for(let t=0;t<o.length;t++)o[t]=!1;const m=new Float32Array(i.length);for(let t=0;t<l;t++)m[t]=-1,m[l*(u-1)+t]=-1;for(let t=0;t<u;t++)m[t*l]=-1,m[t*l+l-1]=-1;for(let t=1;t<l-1;t++)for(let e=1;e<u-1;e++){let r=t+l*e,a=0,s=0;for(let t=-1;t<=1;t++)a+=i[r+l*t+1]-i[r+l*t-1],s+=i[r+l+t]-i[r-l+t];a/=768,s/=768,m[r]=Math.sqrt((a*a+s*s)/2)}const n=new Uint32Array(1e3);for(let t=0;t<1e3;t++)n[t]=0;const c=[-1,1,-l,l];let f=0;for(let t=1;t<l-1;t++)for(let e=1;e<u-1;e++){let r=t+l*e,a=!0;for(let t=0;t<c.length;t++)if(m[r]<=m[r+c[t]]){a=!1;break}if(a){let t=Math.floor(1e3*m[r]);t>999&&(t=999),t<0&&(t=0),n[t]+=1,f+=1,o[r]=!0}}const g=.02*l*u;let d=999,y=0;for(;d>=0&&(y+=n[d],!(y>g));)d--;for(let t=0;t<o.length;t++)o[t]&&1e3*m[t]<d&&(o[t]=!1);const p=[];for(let t=0;t<i.length;t++)p[t]=i[t]*i[t];const M=new t(i,l,u),w=new t(p,l,u),q=new Float32Array(i.length);for(let t=0;t<l;t++)for(let r=0;r<u;r++){const i=r*l+t;if(!o[i]){q[i]=1;continue}const u=a({image:e,cx:t,cy:r,sdThresh:5,imageDataCumsum:M,imageDataSqrCumsum:w});if(null===u){q[i]=1;continue}let h=-1;for(let a=-10;a<=10;a++){for(let i=-10;i<=10;i++){if(i*i+a*a<=4)continue;const l=s({image:e,cx:t+i,cy:r+a,vlen:u,tx:t,ty:r,imageDataCumsum:M,imageDataSqrCumsum:w});if(null!==l&&l>h&&(h=l,h>.95))break}if(h>.95)break}q[i]=h}return r({image:e,featureMap:q,templateSize:6,searchSize:2,occSize:16,maxSimThresh:.9,minSimThresh:.2,sdThresh:8,imageDataCumsum:M,imageDataSqrCumsum:w})},r=t=>{let{image:e,featureMap:r,templateSize:i,searchSize:l,occSize:u,maxSimThresh:h,minSimThresh:o,sdThresh:m,imageDataCumsum:n,imageDataSqrCumsum:c}=t;const{data:f,width:g,height:d,scale:y}=e;u=Math.floor(Math.min(e.width,e.height)/10);const p=3*(2*i+1),M=Math.floor(g/p),w=Math.floor(d/p);let q=Math.floor(g/u)*Math.floor(d/u)+M*w;const S=[],D=new Float32Array(f.length);for(let t=0;t<D.length;t++)D[t]=r[t];let C=0;for(;C<q;){let t=h,r=-1,f=-1;for(let e=0;e<d;e++)for(let a=0;a<g;a++)D[e*g+a]<t&&(t=D[e*g+a],r=a,f=e);if(-1===r)break;const y=a({image:e,cx:r,cy:f,sdThresh:0,imageDataCumsum:n,imageDataSqrCumsum:c});if(null===y){D[f*g+r]=1;continue}if(y/(2*i+1)<m){D[f*g+r]=1;continue}let p=1,M=-1;for(let a=-l;a<=l;a++){for(let i=-l;i<=l;i++){if(i*i+a*a>l*l)continue;if(0===i&&0===a)continue;const u=s({image:e,vlen:y,cx:r+i,cy:f+a,tx:r,ty:f,imageDataCumsum:n,imageDataSqrCumsum:c});if(null!==u){if(u<p&&(p=u,p<o&&p<t))break;if(u>M&&(M=u,M>.99))break}}if(p<o&&p<t||M>.99)break}if(p<o&&p<t||M>.99)D[f*g+r]=1;else{S.push({x:r,y:f}),C+=1;for(let t=-u;t<=u;t++)for(let e=-u;e<=u;e++)f+t<0||f+t>=d||r+e<0||r+e>=g||(D[(f+t)*g+(r+e)]=1)}}return S},a=({image:t,cx:e,cy:r,sdThresh:a,imageDataCumsum:s,imageDataSqrCumsum:i})=>{if(e-6<0||e+6>=t.width)return null;if(r-6<0||r+6>=t.height)return null;let l=s.query(e-6,r-6,e+6,r+6);l/=169;let u=i.query(e-6,r-6,e+6,r+6);return u-=2*l*s.query(e-6,r-6,e+6,r+6),u+=169*l*l,u/169<a*a?null:(u=Math.sqrt(u),u)},s=t=>{const{image:e,cx:r,cy:a,vlen:s,tx:i,ty:l,imageDataCumsum:u,imageDataSqrCumsum:h}=t,{data:o,width:m,height:n}=e;if(r-6<0||r+6>=m)return null;if(a-6<0||a+6>=n)return null;let c=u.query(r-6,a-6,r+6,a+6),f=h.query(r-6,a-6,r+6,a+6),g=0,d=(a-6)*m+(r-6),y=(l-6)*m+(i-6),p=m-13;for(let t=0;t<13;t++){for(let t=0;t<13;t++)g+=o[d]*o[y],d+=1,y+=1;d+=p,y+=p}let M=u.query(i-6,l-6,i+6,l+6);M/=169,g-=M*c;let w=f-c*c/169;return 0==w?null:(w=Math.sqrt(w),1*g/(s*w))},i=({image:t,ratio:e})=>{const r=Math.round(t.width*e),a=Math.round(t.height*e),s=new Uint8Array(r*a);for(let i=0;i<r;i++){let l=Math.round(1*i/e),u=Math.round(1*(i+1)/e)-1;u>=t.width&&(u=t.width-1);for(let h=0;h<a;h++){let a=Math.round(1*h/e),o=Math.round(1*(h+1)/e)-1;o>=t.height&&(o=t.height-1);let m=0,n=0;for(let e=l;e<=u;e++)for(let r=a;r<=o;r++)m+=1*t.data[r*t.width+e],n+=1;s[h*r+i]=Math.floor(m/n)}}return{data:s,width:r,height:a}},l=t=>{const e=Math.min(t.width,t.height),r=[],a=[];r.push(256/e),r.push(128/e);for(let e=0;e<r.length;e++)a.push(Object.assign(i({image:t,ratio:r[e]}),{scale:r[e]}));return a};onmessage=t=>{const{data:e}=t;if("compile"===e.type){const{targetImages:t}=e,r=50/t.length;let a=0;const s=[];for(let e=0;e<t.length;e++){const i=t[e],h=l(i),o=r/h.length,m=u(h,(t=>{a+=o,postMessage({type:"progress",percent:a})}));s.push(m)}postMessage({type:"compileDone",list:s})}};const u=(t,r)=>{const a=[];for(let s=0;s<t.length;s++){const i=t[s],l=e(i),u={data:i.data,scale:i.scale,width:i.width,height:i.height,points:l};a.push(u),r(s)}return a};